# ✅ 全局参数系统测试清单

## 🧪 测试步骤

### 准备工作

```bash
# 1. 确保后端运行
make api
# 访问 http://127.0.0.1:8000/docs 确认

# 2. 启动前端
cd viz
npm run dev
# 访问显示的地址（通常是 http://localhost:3000）
```

---

## 第一部分：基础功能测试

### ✅ Test 1: 应用启动

- [ ] 应用正常加载
- [ ] 顶部显示标题
- [ ] 左侧边栏显示 7 个页面
- [ ] 底部显示 "Parameters" 按钮
- [ ] Console 显示：
  ```
  🔄 Fetching available parameters from backend...
  ✅ Available parameters loaded: {...}
  ```

### ✅ Test 2: 全局参数面板

- [ ] 点击 "Parameters" 按钮
- [ ] 弹出半透明浮动面板
- [ ] 面板显示 "Current Scenario: sc_xxx"
- [ ] 所有 6 个参数都显示
- [ ] 可以关闭面板（点击 X 或 "Apply & Close"）

### ✅ Test 3: 参数调整

**在 Parameters 面板中**:

- [ ] 调整 Climate Scenario 按钮
  - Console 显示: `🔧 Updating parameter: climateScenario = ...`
  - 顶部场景名称变化

- [ ] 拖动 Fertility Rate 滑块
  - Console 显示: `🔧 Updating parameter: fertility = ...`
  - `🔍 Resolving scenario...`
  - `✅ Scenario resolved: sc_xxx`

- [ ] 调整 Diet Pattern
  - 场景名称立即更新

- [ ] 点击 "Reset to Defaults"
  - 所有参数恢复默认值
  - 场景重新解析

---

## 第二部分：跨页面联动测试

### ✅ Test 4: 页面切换参数保持

1. [ ] 打开 Parameters 面板
2. [ ] 设置: Fertility = 1.8, Diet = 3
3. [ ] 关闭面板，记录场景名称 (如 sc_1234)
4. [ ] 切换到 Page 2
5. [ ] 再切换回 Page 3
6. [ ] 场景名称应该还是 sc_1234 ✅

### ✅ Test 5: 参数影响所有页面

**准备**: 打开两个浏览器标签页或使用分屏

1. [ ] 标签页 A: 停留在 Page 3
2. [ ] 标签页 B: 停留在 Page 6
3. [ ] 在任意标签页打开 Parameters
4. [ ] 调整 Fertility = 1.6
5. [ ] 两个标签页的场景名称都应该变化 ✅
6. [ ] 图表都会显示加载状态

### ✅ Test 6: 实时数据更新

**使用 DemographicsPageWithGlobalParams 测试**:

1. [ ] 在 App.tsx 中临时启用新版页面:
   ```tsx
   import DemographicsPage from './components/pages/DemographicsPageWithGlobalParams';
   ```

2. [ ] 刷新应用，进入 Page 3

3. [ ] 打开 Parameters 面板

4. [ ] 调整 Fertility 从 1.7 → 1.8
   - Console 应显示:
     ```
     🔧 Updating parameter: fertility = 1.8
     🔍 Resolving scenario...
     ✅ Scenario resolved: sc_xxx
     📊 Fetching total_population for scenario sc_xxx...
     📊 Fetching domestic_water_demand_province_sum...
     📊 Fetching oa_water_demand_province_sum...
     ✅ Loaded total_population: 377 data points
     ✅ Loaded domestic_water_demand_province_sum: 377 points
     ✅ Loaded oa_water_demand_province_sum: 377 points
     ```

5. [ ] 三个图表应该全部更新 ✅

6. [ ] 改变 Diet Pattern 1 → 2 → 3
   - 每次变化图表都会更新

---

## 第三部分：性能测试

### ✅ Test 7: 响应速度

- [ ] 调整参数到图表更新 < 2 秒
- [ ] 没有卡顿或冻结
- [ ] 加载状态提示清晰

### ✅ Test 8: API 调用优化

**打开 Network 标签 (F12)**:

1. [ ] 调整一个参数
2. [ ] 应该只看到：
   - 1 次 `/resolve_scenario` 调用
   - N 次 `/series` 调用（N = 页面使用的变量数）
3. [ ] 不应该有重复的请求

### ✅ Test 9: 内存泄漏测试

1. [ ] 快速切换页面 10 次
2. [ ] 快速调整参数 10 次
3. [ ] 观察 Console 没有报错
4. [ ] 应用仍然流畅运行

---

## 第四部分：边界情况测试

### ✅ Test 10: 后端未启动

1. [ ] 停止后端服务
2. [ ] 刷新应用
3. [ ] Console 应显示错误但应用不崩溃
4. [ ] 重启后端后应恢复正常

### ✅ Test 11: 无效参数

1. [ ] 手动在 Console 中调用:
   ```javascript
   // 假设你能访问到 context
   updateParameter('fertility', 999); // 无效值
   ```
2. [ ] 应用应该能处理错误

### ✅ Test 12: 快速连续调整

1. [ ] 快速拖动滑块多次
2. [ ] 观察只有最终值生效
3. [ ] 没有多余的 API 调用

---

## 第五部分：UI/UX 测试

### ✅ Test 13: 暗黑模式

- [ ] 切换到暗黑模式
- [ ] 参数面板样式正确
- [ ] 所有文字可读
- [ ] 状态标签颜色合适

### ✅ Test 14: 响应式布局

- [ ] 缩小浏览器窗口
- [ ] 参数面板不超出屏幕
- [ ] 所有控件可点击
- [ ] 滚动条正常工作

### ✅ Test 15: 可访问性

- [ ] 所有按钮有 aria-label
- [ ] Tab 键可以导航
- [ ] 工具提示显示正确

---

## 📊 测试结果记录

| 测试项 | 结果 | 备注 |
|--------|------|------|
| Test 1: 应用启动 | ✅/❌ | |
| Test 2: 参数面板 | ✅/❌ | |
| Test 3: 参数调整 | ✅/❌ | |
| Test 4: 页面切换 | ✅/❌ | |
| Test 5: 跨页面联动 | ✅/❌ | |
| Test 6: 实时更新 | ✅/❌ | |
| Test 7: 响应速度 | ✅/❌ | 实际耗时: ___ ms |
| Test 8: API 优化 | ✅/❌ | 调用次数: ___ |
| Test 9: 内存泄漏 | ✅/❌ | |
| Test 10: 容错处理 | ✅/❌ | |
| Test 11: 边界情况 | ✅/❌ | |
| Test 12: 连续操作 | ✅/❌ | |
| Test 13: 暗黑模式 | ✅/❌ | |
| Test 14: 响应式 | ✅/❌ | |
| Test 15: 可访问性 | ✅/❌ | |

---

## 🐛 发现的问题记录

| 问题描述 | 严重程度 | 重现步骤 | 解决方案 |
|---------|---------|---------|---------|
| | | | |

---

## ✍️ 测试人员签名

- **测试日期**: _______________
- **测试人员**: _______________
- **浏览器版本**: _______________
- **测试结果**: 通过 ✅ / 需要修复 ❌

---

## 📝 备注

在这里记录任何额外的观察、建议或反馈：

```
[您的备注]
```

---

**测试愉快！** 🎉
