# ğŸ”§ éƒ¨ç½²æ›´æ–°ä¸ç”Ÿæ•ˆé—®é¢˜æ’æŸ¥æŒ‡å—

## å¿«é€Ÿè¯Šæ–­

å¦‚æœä½ å·²ç»éƒ¨ç½²äº†æ–°ç‰ˆæœ¬ï¼Œä½†æµè§ˆå™¨æ˜¾ç¤ºçš„è¿˜æ˜¯æ—§ç‰ˆæœ¬ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

### ç¬¬ä¸€æ­¥ï¼šè¿è¡Œè¯Šæ–­è„šæœ¬

```bash
./diagnose-deployment.sh
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥ï¼š
- âœ… æœ¬åœ°æ„å»ºçŠ¶æ€
- âœ… æœåŠ¡å™¨æ–‡ä»¶çŠ¶æ€
- âœ… Docker å®¹å™¨çŠ¶æ€
- âœ… å®¹å™¨å†…æ–‡ä»¶çŠ¶æ€
- âœ… ç½‘ç»œè®¿é—®çŠ¶æ€

**è¯Šæ–­è„šæœ¬ä¸ä¼šåšä»»ä½•ä¿®æ”¹**ï¼Œåªæ˜¯æ”¶é›†ä¿¡æ¯å¸®ä½ å®šä½é—®é¢˜ã€‚

### ç¬¬äºŒæ­¥ï¼šæ ¹æ®è¯Šæ–­ç»“æœé‡‡å–è¡ŒåŠ¨

#### æƒ…å†µ 1ï¼šæœ¬åœ°æœªæ„å»º
**ç—‡çŠ¶**: è¯Šæ–­æ˜¾ç¤º `viz/build` ç›®å½•ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**:
```bash
cd viz
npm run build
cd ..
./deploy-v2.sh
```

#### æƒ…å†µ 2ï¼šæœåŠ¡å™¨ä¸Šæ–‡ä»¶æœªæ›´æ–°
**ç—‡çŠ¶**: æœ¬åœ°å’ŒæœåŠ¡å™¨çš„æ–‡ä»¶ä¿®æ”¹æ—¶é—´æˆ–æ–‡ä»¶åä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**:
```bash
./fix-deployment.sh
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- 1) åœæ­¢ç°æœ‰æœåŠ¡
- 2) åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ—§æ„å»ºæ–‡ä»¶
- 3) ä¸Šä¼ æ–°çš„æ„å»ºæ–‡ä»¶
- 4) å¼ºåˆ¶é‡æ–°æ„å»º Docker é•œåƒï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
- 5) é‡æ–°å¯åŠ¨æœåŠ¡
- 6) éªŒè¯æœåŠ¡çŠ¶æ€ä¸å¯è®¿é—®æ€§

#### æƒ…å†µ 3ï¼šDocker é•œåƒç¼“å­˜é—®é¢˜
**ç—‡çŠ¶**: æœåŠ¡å™¨æ–‡ä»¶å·²æ›´æ–°ï¼Œä½†å®¹å™¨å†…çš„æ–‡ä»¶æ˜¯æ—§çš„

**è§£å†³æ–¹æ¡ˆ**:
```bash
ssh ubuntu@43.165.1.18 'cd /home/ubuntu/watm-dt && \
  docker compose down && \
  docker compose build --no-cache frontend && \
  docker compose up -d'
```

#### æƒ…å†µ 4ï¼šæµè§ˆå™¨ç¼“å­˜ï¼ˆè™½ç„¶ä½ è¯´è¯•è¿‡æ— ç—•æ¨¡å¼ï¼‰
**ç—‡çŠ¶**: æ‰€æœ‰æœåŠ¡å™¨æ£€æŸ¥éƒ½æ­£å¸¸ï¼Œä½†æµè§ˆå™¨æ˜¾ç¤ºæ—§ç‰ˆæœ¬

**è§£å†³æ–¹æ¡ˆ**:
1. æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. å‹¾é€‰ "Disable cache"
4. æŒ‰ Cmd+Shift+R (macOS) æˆ– Ctrl+Shift+R (Windows/Linux) å¼ºåˆ¶åˆ·æ–°

---

## å¸¸è§é—®é¢˜è¯¦è§£

### é—®é¢˜ 1: Docker é•œåƒä½¿ç”¨äº†ç¼“å­˜

**åŸå› **: Docker åœ¨æ„å»ºé•œåƒæ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°æŸä¸€å±‚æ²¡æœ‰å˜åŒ–ï¼Œä¼šä½¿ç”¨ç¼“å­˜å±‚ã€‚è¿™å¯èƒ½å¯¼è‡´æ–°ä»£ç æ²¡æœ‰è¢«æ‰“åŒ…è¿›é•œåƒã€‚

**è¯†åˆ«æ–¹æ³•**:
```bash
# æ£€æŸ¥æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶
ssh ubuntu@43.165.1.18 'ls -lht /home/ubuntu/watm-dt/viz/build/ | head -5'

# æ£€æŸ¥å®¹å™¨å†…çš„æ–‡ä»¶
ssh ubuntu@43.165.1.18 'docker exec watm-dt-frontend ls -lht /usr/share/nginx/html/ | head -5'
```

å¦‚æœä¸¤è€…çš„æ–‡ä»¶æ—¶é—´æˆ³æˆ–æ–‡ä»¶åä¸ä¸€è‡´ï¼Œå°±æ˜¯è¿™ä¸ªé—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `--no-cache` æ ‡å¿—å¼ºåˆ¶é‡æ–°æ„å»º
```bash
ssh ubuntu@43.165.1.18 'cd /home/ubuntu/watm-dt && \
  docker compose build --no-cache frontend && \
  docker compose up -d'
```

### é—®é¢˜ 2: å‰ç«¯æ„å»ºè¾“å‡ºè·¯å¾„é”™è¯¯

**æ£€æŸ¥ç‚¹**:
1. `vite.config.ts` ä¸­çš„ `build.outDir` è®¾ç½®
2. `Dockerfile.frontend` ä¸­ COPY çš„è·¯å¾„
3. `deploy-v2.sh` ä¸­ä¸Šä¼ çš„è·¯å¾„

**å½“å‰é…ç½®**:
- Vite è¾“å‡º: `viz/build/` âœ…
- Dockerfile å¤åˆ¶: `/app/build` âœ…
- Nginx ç›®å½•: `/usr/share/nginx/html` âœ…

è¿™äº›é…ç½®æ˜¯æ­£ç¡®çš„ï¼Œä¸€èˆ¬ä¸æ˜¯é—®é¢˜æ‰€åœ¨ã€‚

### é—®é¢˜ 3: Nginx ç¼“å­˜é…ç½®

**å½“å‰é…ç½®** (nginx.conf):
```nginx
# HTML æ–‡ä»¶ä¸ç¼“å­˜
location ~* \.html$ {
    expires -1;
    add_header Cache-Control "no-store, no-cache, must-revalidate";
}

# JS/CSS æ–‡ä»¶é•¿æœŸç¼“å­˜ï¼ˆä¾èµ–æ–‡ä»¶åä¸­çš„ hashï¼‰
location ~* \.(js|css|...)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

è¿™ä¸ªé…ç½®æ˜¯æ­£ç¡®çš„ã€‚å‰ç«¯æ„å»ºä¼šä¸º JS/CSS æ–‡ä»¶åæ·»åŠ  hashï¼ˆå¦‚ `index-abc123.js`ï¼‰ï¼Œæ¯æ¬¡æ„å»º hash éƒ½ä¼šå˜åŒ–ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ç¼“å­˜é—®é¢˜ã€‚

**éªŒè¯æ–¹æ³•**:
```bash
# æŸ¥çœ‹å®é™…è¿”å›çš„ HTML
curl -s http://43.165.1.18/ | grep -o 'src="[^"]*\.js"'

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡º:
# src="/assets/index-msTSMgkN.js"
```

æ¯æ¬¡æ„å»ºåï¼Œè¿™ä¸ª hashï¼ˆ`msTSMgkN`ï¼‰åº”è¯¥ä¼šå˜åŒ–ã€‚å¦‚æœæ²¡å˜ï¼Œè¯´æ˜ Docker é•œåƒæ²¡æœ‰æ›´æ–°ã€‚

---

## å®Œæ•´çš„æ›´æ–°æµç¨‹

### æ ‡å‡†æµç¨‹ï¼ˆæ¨èï¼‰

```bash
# 1. æœ¬åœ°æ„å»ºå‰ç«¯
cd viz
npm run build
cd ..

# 2. è¿è¡Œè¯Šæ–­æ£€æŸ¥ï¼ˆå¯é€‰ä½†æ¨èï¼‰
./diagnose-deployment.sh

# 3. éƒ¨ç½²åˆ°æœåŠ¡å™¨
./deploy-v2.sh
```

### å¼ºåˆ¶æ›´æ–°æµç¨‹ï¼ˆå½“æ ‡å‡†æµç¨‹ä¸ç”Ÿæ•ˆæ—¶ï¼‰

```bash
# 1. ç¡®ä¿æœ¬åœ°å·²æ„å»º
cd viz && npm run build && cd ..

# 2. è¿è¡Œä¿®å¤è„šæœ¬ï¼ˆåŒ…å«å¼ºåˆ¶é‡å»ºï¼‰
./fix-deployment.sh
```

### æ‰‹åŠ¨å®Œæ•´æ›´æ–°æµç¨‹ï¼ˆå½“è„šæœ¬éƒ½å¤±è´¥æ—¶ï¼‰

```bash
# 1. æœ¬åœ°æ„å»º
cd viz && npm run build && cd ..

# 2. æ¸…ç†æœåŠ¡å™¨ï¼ˆæ¨èï¼šä»…æ¸…ç†æœ¬é¡¹ç›®ï¼‰
ssh ubuntu@43.165.1.18 'cd /home/ubuntu/watm-dt && \
  docker compose down --volumes --rmi all && \
  rm -rf viz/build/*'

# âš ï¸ æ³¨æ„ï¼šé¿å…ä½¿ç”¨å…¨å±€æ¸…ç†å‘½ä»¤ï¼
# docker system prune -af --volumes ä¼šåˆ é™¤æœåŠ¡å™¨ä¸Šæ‰€æœ‰ Docker èµ„æºï¼Œ
# å¯èƒ½å½±å“å…¶ä»–é¡¹ç›®ã€‚è¯·ä½¿ç”¨ä¸Šé¢çš„é¡¹ç›®ä½œç”¨åŸŸæ¸…ç†å‘½ä»¤ã€‚

# 3. é‡æ–°ä¸Šä¼ 
rsync -avz --progress viz/build/ ubuntu@43.165.1.18:/home/ubuntu/watm-dt/viz/build/

# 4. é‡æ–°æ„å»ºå’Œå¯åŠ¨ï¼ˆä¸ä½¿ç”¨ä»»ä½•ç¼“å­˜ï¼‰
ssh ubuntu@43.165.1.18 'cd /home/ubuntu/watm-dt && \
  docker compose build --no-cache && \
  docker compose up -d'

# 5. ç­‰å¾…å¯åŠ¨å¹¶æ£€æŸ¥
sleep 20
ssh ubuntu@43.165.1.18 'cd /home/ubuntu/watm-dt && docker compose ps'
```

---

## éªŒè¯æ›´æ–°æ˜¯å¦ç”Ÿæ•ˆ

### æ–¹æ³• 1: æ£€æŸ¥æ–‡ä»¶ Hash
```bash
# æœ¬åœ°æ„å»ºçš„ JS æ–‡ä»¶
grep -o 'src="[^"]*\.js"' viz/build/index.html

# æœåŠ¡å™¨è¿”å›çš„ JS æ–‡ä»¶
curl -s http://43.165.1.18/ | grep -o 'src="[^"]*\.js"'

# ä¸¤è€…åº”è¯¥ä¸€è‡´
```

### æ–¹æ³• 2: æ£€æŸ¥ç‰ˆæœ¬å·ï¼ˆå¦‚æœä»£ç ä¸­æœ‰ï¼‰
åœ¨å‰ç«¯ä»£ç ä¸­æ·»åŠ ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³ï¼š
```tsx
// åœ¨ App.tsx æˆ–å…¶ä»–ç»„ä»¶ä¸­
console.log('App Version:', '2.0.0', 'Build:', new Date().toISOString());
```

ç„¶ååœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¾“å‡ºã€‚

### æ–¹æ³• 3: æ£€æŸ¥å®¹å™¨åˆ›å»ºæ—¶é—´
```bash
ssh ubuntu@43.165.1.18 'docker inspect watm-dt-frontend | grep "Created"'
```

å¦‚æœåˆ›å»ºæ—¶é—´æ˜¯æœ€è¿‘çš„ï¼Œè¯´æ˜å®¹å™¨æ˜¯æ–°çš„ã€‚

---

## ç´§æ€¥è”ç³»æ–¹å¼

å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½æ— æ•ˆï¼Œè¯·æ£€æŸ¥ï¼š

1. **æœåŠ¡å™¨ç£ç›˜ç©ºé—´**: `ssh ubuntu@43.165.1.18 'df -h'`
2. **Docker æ—¥å¿—**: `ssh ubuntu@43.165.1.18 'cd /home/ubuntu/watm-dt && docker compose logs frontend | tail -100'`
3. **æ˜¯å¦æœ‰ä»£ç†/CDN**: æœ‰äº›äº‘æœåŠ¡å•†ä¼šåœ¨å‰é¢åŠ  CDNï¼Œéœ€è¦åˆ·æ–° CDN ç¼“å­˜

---

## é¢„é˜²æªæ–½

ä¸ºäº†é¿å…ä»¥åé‡åˆ°åŒæ ·çš„é—®é¢˜ï¼Œå»ºè®®ï¼š

### 1. æ¯æ¬¡éƒ¨ç½²å‰è¿è¡Œè¯Šæ–­
```bash
./diagnose-deployment.sh
```

### 2. åœ¨å‰ç«¯æ·»åŠ ç‰ˆæœ¬æ˜¾ç¤º
åœ¨é¡µé¢åº•éƒ¨æˆ–æ§åˆ¶å°æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬å·å’Œæ„å»ºæ—¶é—´ã€‚

### 3. ä½¿ç”¨ç‰ˆæœ¬æ ‡ç­¾
ä¸ºæ¯æ¬¡é‡è¦æ›´æ–°æ‰“ Git tagï¼š
```bash
git tag -a v2.0.0 -m "Release version 2.0.0"
git push origin v2.0.0
```

### 4. æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹
åœ¨å‰ç«¯æ·»åŠ ä¸€ä¸ª `/version.json` æ–‡ä»¶ï¼ŒåŒ…å«ç‰ˆæœ¬ä¿¡æ¯ï¼š
```json
{
  "version": "2.0.0",
  "buildTime": "2025-01-21T10:30:00Z",
  "commit": "abc123"
}
```

è¿™æ ·å¯ä»¥ç›´æ¥è®¿é—® `http://43.165.1.18/version.json` æ£€æŸ¥ç‰ˆæœ¬ã€‚

---

## å¿«é€Ÿå‚è€ƒ

| é—®é¢˜ç—‡çŠ¶ | å¯èƒ½åŸå›  | è§£å†³å‘½ä»¤ |
|---------|---------|---------|
| æµè§ˆå™¨æ˜¾ç¤ºæ—§ç‰ˆæœ¬ | å¤šç§å¯èƒ½ | `./diagnose-deployment.sh` |
| è¯Šæ–­æ˜¾ç¤ºæ–‡ä»¶ä¸ä¸€è‡´ | Docker ç¼“å­˜ | `./fix-deployment.sh` |
| å®¹å™¨å†…æ–‡ä»¶æ˜¯æ—§çš„ | é•œåƒç¼“å­˜ | `docker compose build --no-cache` |
| æœåŠ¡æ— æ³•è®¿é—® | å®¹å™¨æœªå¯åŠ¨ | `docker compose up -d` |
| æœ¬åœ°æœªæ„å»º | å¿˜è®°æ„å»º | `cd viz && npm run build` |

---

**æœ€åæ›´æ–°**: 2025-01-21
**ç»´æŠ¤è€…**: SongshGeo
