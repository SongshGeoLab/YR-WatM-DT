# WatM-DT: Water Management Decision Theater

## Project Overview

A decision theater application for exploring water management scenarios in the Yellow River Basin (YRB), combining Python-based data processing with a React frontend for interactive visualization.

## ğŸ“– User Guides

- **[ä¸­æ–‡ç”¨æˆ·æ‰‹å†Œ](USER_GUIDE_CN.md)** - å®Œæ•´çš„ä¸­æ–‡ä½¿ç”¨æŒ‡å—
- **[English User Guide](USER_GUIDE_EN.md)** - Complete English usage guide

For end users, please refer to the user guides above. The technical documentation below is for developers and system administrators.

## ğŸš€ Latest Updates

> **æ³¨æ„**: æœ¬é¡¹ç›®ä½¿ç”¨ [Google Release Please](https://github.com/googleapis/release-please) è¿›è¡Œè‡ªåŠ¨åŒ–ç‰ˆæœ¬ç®¡ç†ã€‚ç‰ˆæœ¬å·ç”±æäº¤æ¶ˆæ¯è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹ã€‚

å½“å‰ç‰ˆæœ¬: **v1.2.0** â†’ **v2.0.0** (å¾…å‘å¸ƒ)

### Complete Page Refactoring
- âœ… **Page 1: Introduction** - Yellow River Basin overview with river analysis bubble charts
- âœ… **Page 2: Climate Change Impact Analysis** - Complete real data integration with SNWTP toggle
- âœ… **Page 3: Demographics & Domestic Water** - Multi-scenario analysis with peak year detection
- âœ… **Page 4: Ecological Water Flow** - Threshold comparison with SNWTP impact analysis
- âœ… **Page 5: Water Demand Analysis** - Irrigation and production water demand with parameter sliders
- âœ… **Page 6: Water Composition Analysis** - Water demand composition trends and total demand analysis
- âœ… **Page 7: Water Stress Index Analysis** - Global scenario selection and water stress monitoring

### Key Technical Achievements
- ğŸ”§ **Complete Real Data Integration**: All 7 pages now use actual backend data
- ğŸŒ **Global Scenario Selection**: Moved to Page 7 for better user flow
- ğŸ“Š **Now vs Future Comparison Panels**: Added comparison panels for Pages 5 & 6
- ğŸ¨ **Optimized UI**: Improved navigation width and unified page labeling
- ğŸ“ˆ **Advanced Analytics**: Multi-scenario uncertainty visualization with confidence intervals
- ğŸ§¹ **Code Cleanup**: Removed redundant components and optimized file structure

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend (viz/)                                                 â”‚
â”‚  React + Vite + Plotly.js                                       â”‚
â”‚  â€¢ Interactive charts and parameter controls                    â”‚
â”‚  â€¢ 7 themed pages (Study Area, Water Availability, etc.)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP/JSON
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend API (scripts/api_server.py)                            â”‚
â”‚  FastAPI + Polars                                               â”‚
â”‚  â€¢ GET /variables, /params, /time                              â”‚
â”‚  â€¢ POST /resolve_scenario                                       â”‚
â”‚  â€¢ GET /series (variable Ã— scenario â†’ time series)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ Reads
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Layer (data_parquet/)                                     â”‚
â”‚  Columnar Parquet files                                         â”‚
â”‚  â€¢ time.parquet: [step, time]                                  â”‚
â”‚  â€¢ scenarios.parquet: [scenario_name, param1..paramN, SNWTP]   â”‚
â”‚  â€¢ {variable}.parquet: [scenario_name, step, value, variable]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Structure

### Input (Raw CSV)

Located in `data/`:
- `TIME.csv`: 4725 base scenarios Ã— 1905 timesteps (years)
- `scenario_combinations3.xlsx`: Parameter combinations â†’ 4725 base scenario rows
- 12 variable CSVs (e.g., `Total population.csv`, `YRB available surface water.csv`): each 4725Ã—1905
- **Note**: SNWTP (South-North Water Transfer Project) parameter is added during preprocessing, doubling scenarios to 9450

### Preprocessed (Parquet)

Generated by `scripts/preprocess_to_parquet.py` â†’ `data_parquet/`:

#### 1. **time.parquet**
```
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ step â”‚ time     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0    â”‚ 1981.0   â”‚
â”‚ 1    â”‚ 1982.0   â”‚
â”‚ ...  â”‚ ...      â”‚
â”‚ 1904 â”‚ 2885.0   â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. **scenarios.parquet**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ scenario_name â”‚ Fertility Variation â”‚ water saving irrigation efficiency ratio â”‚ SNWTP  â”‚ ... â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
â”‚ sc_0          â”‚ 1.6                 â”‚ 0.8                                      â”‚ 0      â”‚ ... â”‚
â”‚ sc_0_snwtp    â”‚ 1.6                 â”‚ 0.8                                      â”‚ 1      â”‚ ... â”‚
â”‚ sc_1          â”‚ 1.6                 â”‚ 0.8                                      â”‚ 0      â”‚ ... â”‚
â”‚ sc_1_snwtp    â”‚ 1.6                 â”‚ 0.8                                      â”‚ 1      â”‚ ... â”‚
â”‚ ...           â”‚ ...                 â”‚ ...                                      â”‚ ...    â”‚ ... â”‚
â”‚ sc_4724       â”‚ 1.8                 â”‚ 1.0                                      â”‚ 0      â”‚ ... â”‚
â”‚ sc_4724_snwtp â”‚ 1.8                 â”‚ 1.0                                      â”‚ 1      â”‚ ... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
```
**Total scenarios**: 9450 (4725 base Ã— 2 SNWTP options)

#### 3. **Variable Parquet** (e.g., `Total population.parquet`)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ scenario_name â”‚ step â”‚ value      â”‚ variable         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sc_0          â”‚ 0    â”‚ 450000000  â”‚ Total population â”‚
â”‚ sc_0          â”‚ 1    â”‚ 451200000  â”‚ Total population â”‚
â”‚ sc_0_snwtp    â”‚ 0    â”‚ 450000000  â”‚ Total population â”‚
â”‚ sc_0_snwtp    â”‚ 1    â”‚ 451200000  â”‚ Total population â”‚
â”‚ ...           â”‚ ...  â”‚ ...        â”‚ ...              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
Each variable file contains ~18M rows (9450 scenarios Ã— 1905 steps).

---

## API Endpoints

### Base URL
`http://127.0.0.1:8000` (default)

### Endpoints

#### GET `/variables`
Returns list of available variables (excludes TIME).
```json
[
  "GDP per capita",
  "Total population",
  "YRB available surface water",
  ...
]
```

#### GET `/params`
Returns parameter names and their unique values.
```json
{
  "Fertility Variation": [1.6, 1.7, 1.8],
  "water saving irrigation efficiency ratio": [0.8, 0.9, 1.0],
  ...
}
```

#### POST `/resolve_scenario`
Resolve scenario name from parameter values.
```json
// Request
{
  "values": {
    "Fertility Variation": 1.6,
    "water saving irrigation efficiency ratio": 0.8,
    ...
  }
}

// Response
{
  "scenario_name": "sc_0"
}
```

#### GET `/time`
Returns time vector.
```json
[
  {"step": 0, "time": 1981.0},
  {"step": 1, "time": 1982.0},
  ...
]
```

#### GET `/series?variable={var}&scenario={sc}&start_step={n}&end_step={m}`
Returns time series for a variable under a scenario.
```json
{
  "variable": "Total population",
  "scenario": "sc_0",
  "series": {
    "time": [1981.0, 1982.0, ...],
    "value": [450000000, 451200000, ...]
  }
}
```

#### GET `/series/multi?variable={var}&filters={json}&start_year={y1}&end_year={y2}&aggregate={bool}`
**New in v2.0**: Returns aggregated time series for multiple scenarios matching filters.
```json
// Request
GET /series/multi?variable=YRB%20available%20surface%20water
  &filters={"Climate change scenario switch for water yield": [1,2,3], "SNWTP": 0}
  &start_year=2020&end_year=2100&aggregate=true

// Response
{
  "variable": "YRB available surface water",
  "n_scenarios": 15,
  "isSingleScenario": false,
  "filter_summary": {
    "Climate change scenario switch for water yield": [1, 2, 3],
    "SNWTP": 0
  },
  "series": {
    "time": [2020.0, 2021.0, ...],
    "mean": [55.2, 56.1, ...],
    "min": [48.3, 49.0, ...],
    "max": [62.8, 63.5, ...],
    "std": [4.2, 4.3, ...],
    "p05": [50.1, 50.8, ...],
    "p95": [60.3, 61.1, ...]
  }
}
```
**Features**:
- Filters scenarios by parameter constraints
- Supports multi-value filters (e.g., climate scenarios [1,2,3])
- Returns statistical aggregation (mean, min, max, std, p05, p95)
- Automatically detects single vs. multi-scenario mode
- SNWTP parameter supported (0=off, 1=on)

#### GET `/climate-data`
**New in v2.0**: Returns RCP/SSP climate scenario data (temperature and precipitation).
```json
{
  "temperature": {
    "ssp126_corrected": {
      "scenario": "ssp126_corrected",
      "variable": "Temperature",
      "values": [12.3, 12.4, ...]
    },
    "ssp245_corrected": {...},
    "ssp585_corrected": {...}
  },
  "precipitation": {
    "ssp126_corrected": {
      "scenario": "ssp126_corrected",
      "variable": "Precipitation",
      "values": [520.5, 522.1, ...]
    },
    "ssp245_corrected": {...},
    "ssp585_corrected": {...}
  },
  "years": [1981, 1982, ..., 2100]
}
```
**Use case**: Climate impact analysis and scenario comparison panels.

---

## Frontend Structure

```
viz/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.tsx                              # Entry point
â”‚   â”œâ”€â”€ App.tsx                               # Main app with 7-page tabs
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ charts/
â”‚   â”‚   â”‚   â”œâ”€â”€ PlotlyChart.tsx              # Reusable Plotly wrapper (with dark mode)
â”‚   â”‚   â”‚   â””â”€â”€ BasicChart.tsx               # Fallback chart component
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”œâ”€â”€ EcologicalWaterPageSlider.tsx # âœ… Page 4 (fully integrated)
â”‚   â”‚   â”‚   â”œâ”€â”€ WaterAvailabilityPage.tsx    # âœ… Page 2 (fully integrated) **NEW**
â”‚   â”‚   â”‚   â”œâ”€â”€ StudyAreaPage.tsx            # Page 1 (static design)
â”‚   â”‚   â”‚   â”œâ”€â”€ DemographicsPage.tsx         # Page 3 (static design)
â”‚   â”‚   â”‚   â”œâ”€â”€ AgriculturePage.tsx          # Page 5 (static design)
â”‚   â”‚   â”‚   â”œâ”€â”€ WaterStressPage.tsx          # Page 6 (static design)
â”‚   â”‚   â”‚   â””â”€â”€ WaterQualityPage.tsx         # Page 7 (static design)
â”‚   â”‚   â”œâ”€â”€ DataComparisonPanel.tsx          # **NEW**: Climate impact comparison component
â”‚   â”‚   â”œâ”€â”€ GlobalParameterPanel.tsx         # Global scenario parameter controls
â”‚   â”‚   â””â”€â”€ ui/                              # shadcn/Radix UI components
â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â””â”€â”€ ScenarioContext.tsx              # Global state management for scenarios
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ api.ts                           # API client functions
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useApiData.ts                    # Data fetching hooks
â”‚   â”‚   â””â”€â”€ useClimateComparison.ts          # **NEW**: Climate data comparison hook
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ globals.css                      # Global styles
â”œâ”€â”€ BACKEND_INTEGRATION_GUIDE.md            # ğŸ“š Standard integration guide
â”œâ”€â”€ package.json
â”œâ”€â”€ vite.config.ts
â””â”€â”€ index.html
```

### Key Components

#### PlotlyChart
Reusable Plotly component with dark mode support:
```tsx
<PlotlyChart
  id="unique-chart-id"
  title="Chart Title"
  height="400px"
  data={plotlyData}    // Plotly.Data[]
  layout={plotlyLayout}  // Partial<Plotly.Layout> (auto dark mode)
  config={{ responsive: true, displaylogo: false }}
/>
```

#### âœ… Fully Integrated Pages

##### **Page 4: Ecological Water** (`EcologicalWaterPageSlider.tsx`)
Complete backend integration with slider controls:
- Real-time parameter adjustment (ecological flow: 0.2, 0.25, 0.3)
- Multi-variable support (surface water, discharge, sediment)
- Dark mode adaptive charts
- Statistical analysis panel
- 2020-2100 time range focus

##### **Page 2: Water Availability** (`WaterAvailabilityPage.tsx`) **NEW in v2.0**
Climate change scenario integration with advanced features:
- **Climate Scenario Selection**: RCP2.6, RCP4.5, RCP8.5 pathways
- **SNWTP Toggle**: Local parameter for South-North Water Transfer Project (only affects surface water)
- **Multi-Scenario Aggregation**: Displays mean values with uncertainty bands (min/max) when multiple scenarios match
- **Single-Scenario Mode**: Shows individual scenario line when filters result in one scenario
- **Climate Impact Panel** (`DataComparisonPanel`):
  - Temperature change (2020 â†’ 2100)
  - Precipitation change (2020 â†’ 2100)
  - Water availability change (2020 â†’ 2100)
  - Visual indicators for positive/negative trends
- **Real Data Integration**: All charts use actual scenario data from backend
- **Responsive Layout**: Auto-sizing panels without scrollbars

**Technical Features**:
- Custom data fetching with SNWTP parameter (independent of global state)
- `useClimateComparison` hook for climate data analysis
- Automatic detection of single vs. multi-scenario display
- Uncertainty visualization using Plotly fill areas

#### ğŸ¨ Static Design Pages (Ready for Integration)
- `StudyAreaPage.tsx`: Geographic overview with map placeholder
- `DemographicsPage.tsx`: Population and demographic trends
- `AgriculturePage.tsx`: Agricultural water use and irrigation
- `WaterStressPage.tsx`: Water stress indicators and vulnerability
- `WaterQualityPage.tsx`: Water quality parameters and pollution

---

## ğŸ‰ Success Stories: Fully Integrated Pages

### Page 2: Climate & Water Availability (v2.0)
**Advanced multi-scenario analysis with climate impact visualization**

#### What We Built
- **Climate Pathway Selection**: Interactive RCP scenario switching (RCP2.6, RCP4.5, RCP8.5)
- **SNWTP Local Parameter**: Independent toggle for South-North Water Transfer Project
  - Only affects surface water availability
  - Works alongside global parameters
  - Demonstrates local parameter pattern for page-specific controls
- **Intelligent Scenario Display**:
  - **Single Scenario Mode**: Shows one line when filters yield unique scenario
  - **Multi-Scenario Mode**: Shows mean Â± uncertainty bands (min/max) when multiple scenarios match
  - Automatic detection with scenario count display
- **Climate Impact Dashboard**: Real-time calculation of temperature, precipitation, and water availability changes (2020â†’2100)
- **Responsive Design**: Self-adapting layout without scrollbars

#### Technical Achievements
- âœ… **Multi-Scenario Aggregation**: `/series/multi` API with statistical bands
- âœ… **Climate Data Integration**: `/climate-data` endpoint for RCP/SSP data
- âœ… **Custom Data Fetching**: Local SNWTP parameter bypasses global state
- âœ… **Uncertainty Visualization**: Plotly fill areas for confidence intervals
- âœ… **Comparative Analysis**: `useClimateComparison` hook for future projections
- âœ… **Layout Optimization**: Flexbox-based auto-sizing panels

### Page 4: Ecological Water
**Real-time parameter control with statistical analysis**

#### What We Built
- **Real-time Parameter Control**: Slider adjusts ecological flow (0.2, 0.25, 0.3)
- **Multi-Variable Analysis**: Switch between surface water, discharge, and sediment data
- **Dark Mode Support**: Charts automatically adapt to theme changes
- **Statistical Dashboard**: Mean, max, min values with corresponding years
- **2020-2100 Focus**: Optimized for climate projection analysis

#### Technical Achievements
- âœ… **API Integration**: Full backend connectivity with error handling
- âœ… **State Management**: Real-time updates with React hooks
- âœ… **Chart Rendering**: Plotly.js with responsive design
- âœ… **Theme Adaptation**: Automatic dark/light mode switching
- âœ… **Performance**: Optimized data loading and caching

### Integration Patterns
These implementations demonstrate reusable patterns:
1. **Global Parameters** (Page 4): Parameter changes affect all pages
2. **Local Parameters** (Page 2 SNWTP): Page-specific controls for targeted analysis
3. **Multi-Scenario Analysis** (Page 2): Statistical aggregation across matching scenarios
4. **Climate Data Integration** (Page 2): External dataset integration for comparative analysis

---

## Quick Start

### 1. Preprocess Data
Convert raw CSVs to Parquet (one-time setup):
```bash
make preprocess
```
This generates `data_parquet/` from `data/` + `scenario_combinations3.xlsx`.

### 2. Start Backend API
```bash
make api
# Runs on http://127.0.0.1:8000
# Visit http://127.0.0.1:8000/docs for interactive API docs
```

### 3. Start Frontend
```bash
cd viz
npm install
npm run dev
# Opens http://localhost:3000 (or 3001/3002 if ports busy)
```

### 4. Explore
- Navigate to **Page 4** (Ecological Water) for full backend integration demo
- Features: Slider controls, variable switching, dark mode, real-time updates
- Check browser Console for API logs and Network tab for `/resolve_scenario` calls

---

## Workflow for Design Iteration

### 1. Developer (You)
- Modify backend endpoints in `scripts/api_server.py`
- Update data processing in `scripts/preprocess_to_parquet.py`
- Keep backend running: `make api`

### 2. Designer (Figma Collaboration)
- Works in `viz/src/` (all source code tracked in Git)
- Adjusts layouts, styles, UI components
- Runs `npm run dev` locally to preview changes

### 3. Sync Workflow
```bash
# You commit API + data processing changes
git add scripts/ data_parquet/ pyproject.toml makefile
git commit -m "feat: add new variable endpoint"

# Designer commits frontend changes
cd viz
git add src/
git commit -m "style: update page 3 layout"

# Both push/pull to sync
git push origin master
git pull origin master
```

---

## File Naming Conventions

### Variables
We generate and use "safe variable names" for filenames and APIs while preserving original human-readable names:

- Safe name rules: lowercase; non-alphanumeric â†’ `_`; collapse multiple `_`; trim edges.
- Parquet filenames use safe names, e.g. `data_parquet/yrb_available_surface_water.parquet`.
- Mapping file: `data_parquet/variables_map.json` (original â†’ safe).
- API exposes `GET /variables_map` and accepts either original or safe name in `/series`.

Examples (original â†’ safe):

```
hydrologic station discharge[lijin]           â†’ hydrologic_station_discharge_lijin
YRB available surface water                   â†’ yrb_available_surface_water
sediment load[lijin]                          â†’ sediment_load_lijin
irrigation water demand province sum          â†’ irrigation_water_demand_province_sum
production water demand province sum          â†’ production_water_demand_province_sum
OA water demand province sum                  â†’ oa_water_demand_province_sum
domestic water demand province sum            â†’ domestic_water_demand_province_sum
GDP per capita                                â†’ gdp_per_capita
Total population                              â†’ total_population
YRB WSI                                       â†’ yrb_wsi
water consumption of province in YRB sum      â†’ water_consumption_of_province_in_yrb_sum
```

Frontend/Notebook can display original names while using safe names for stable keys.

### Scenarios
Auto-generated as `sc_0` to `sc_4724` based on parameter combinations.

---

## Dependencies

### Backend (Python)
```toml
# pyproject.toml
python = ">=3.11"
polars = "^1.31.0"
fastapi = "^0.115.0"
uvicorn = {extras = ["standard"], version = "^0.30.6"}
pyarrow = "^21.0.0"
```

Install: `poetry install`

### Frontend (Node.js)
```json
// viz/package.json
"react": "^18.3.1"
"plotly.js-dist-min": "^2.35.2"
"@radix-ui/react-*": "^1.x" (shadcn/ui)
"vite": "6.3.5"
```

Install: `cd viz && npm install`

---

## Troubleshooting

### Frontend doesn't show data
1. Check backend is running: visit `http://127.0.0.1:8000/variables`
2. Check browser Console for API logs and error messages
3. Check Network tab for `/params`, `/resolve_scenario`, `/series` requests
4. Verify parameter names match backend API exactly (case-sensitive)
5. Hard refresh: `Cmd+Shift+R` (macOS) or `Ctrl+Shift+R` (Windows/Linux)

### Dark mode issues
- Charts automatically adapt to theme changes
- If charts don't update: check `isDarkMode()` function and theme listeners

### Port conflicts
- Backend: Change port in `makefile` or run `poetry run uvicorn scripts.api_server:app --port 8001`
- Frontend: Vite auto-increments (3000â†’3001â†’3002...), or set in `vite.config.ts`

### CORS errors
Backend already allows all origins (`allow_origins=["*"]`). If still blocked, check browser console for exact error.

---

## Analysis Workflow (Python/Jupyter)

### ScenarioQuery API

Use `scripts/query_scenarios.py` to filter and extract data for analysis:

```python
from scripts.query_scenarios import ScenarioQuery, quick_query, compare_params

# Initialize query engine
query = ScenarioQuery("data_parquet")

# List available variables and parameters
query.list_variables()
query.param_cols

# Filter scenarios by parameter constraints
filtered = query.filter_scenarios({
    "Fertility Variation": 1.6,
    "Climate change scenario switch for water yield": 1
})
print(f"Matching scenarios: {filtered.height}")

# Get time series for variable(s) under constraints
data = query.get_series(
    variables=["Total population", "YRB WSI"],
    filters={"Fertility Variation": 1.6},
    time_range=(2020, 2050)
)

# Compare parameter impact (wide format for plotting)
comparison = compare_params(
    variable="YRB WSI",
    fixed_params={"Fertility Variation": 1.6, "Diet change scenario switch": 1},
    vary_param="water saving irrigation efficiency ratio",
    time_range=(2020, 2100)
)
# Result: rows=time, columns=parameter values (0.8, 0.9, 1.0)
```

See `docs/example_usage.ipynb` for complete examples.

### Key Methods

| Method | Purpose | Returns |
|--------|---------|---------|
| `filter_scenarios(filters)` | Get scenarios matching parameter constraints | DataFrame of scenarios |
| `get_series(variables, filters, time_range)` | Get time series in long format | DataFrame [scenario, variable, step, time, value, params...] |
| `get_series_wide(variable, filters, columns_col)` | Get time series pivoted for comparison | DataFrame [time, param_val_1, param_val_2, ...] |
| `list_variables()` | List all available variables | List of strings |
| `get_param_summary(filters)` | Summarize parameter distributions | DataFrame of parameter stats |

---

## Next Steps

### ğŸ¯ Immediate Priority
1. **Apply Integration Pattern**: Use `viz/BACKEND_INTEGRATION_GUIDE.md` to integrate remaining 5 pages
2. **Standard Template**: Copy `EcologicalWaterPageSlider.tsx` as starting point for each page
3. **Parameter Mapping**: Each page focuses on different parameter combinations

### For Backend
- Add batch endpoints: `GET /series/batch` for multiple variables/scenarios
- Implement downsampling (LTTB algorithm) for large time series
- Add statistical bands (p10/p90) for scenario ensembles

### For Frontend
- âœ… **Completed**: Ecological Water page with full backend integration
- **Next**: Apply integration pattern to remaining 5 pages using `BACKEND_INTEGRATION_GUIDE.md`
- **Standard Process**: Copy `EcologicalWaterPageSlider.tsx` â†’ modify parameters â†’ update variables
- Add multi-variable comparison (overlay multiple series)
- Implement export (PNG/CSV download)

---

## License

MIT

---

## Contact

Maintained by SongshGeo <songshgeo@gmail.com>

Project Repository: https://github.com/SongshGeoLab/YR-WatM-DT

For issues or questions, please visit the repository or open an issue.

---

## Project Policies

- Branch protection and release workflow: docs/BRANCH_PROTECTION_AND_RELEASE.md
