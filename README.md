# WatM-DT: Water Management Decision Theater

## Project Overview

A decision theater application for exploring water management scenarios in the Yellow River Basin (YRB), combining Python-based data processing with a React frontend for interactive visualization.

## 📖 User Guides

- **[中文用户手册](USER_GUIDE_CN.md)** - 完整的中文使用指南
- **[English User Guide](USER_GUIDE_EN.md)** - Complete English usage guide

For end users, please refer to the user guides above. The technical documentation below is for developers and system administrators.

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  Frontend (viz/)                                                 │
│  React + Vite + Plotly.js                                       │
│  • Interactive charts and parameter controls                    │
│  • 7 themed pages (Study Area, Water Availability, etc.)       │
└──────────────────────────┬──────────────────────────────────────┘
                           │ HTTP/JSON
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│  Backend API (scripts/api_server.py)                            │
│  FastAPI + Polars                                               │
│  • GET /variables, /params, /time                              │
│  • POST /resolve_scenario                                       │
│  • GET /series (variable × scenario → time series)             │
└──────────────────────────┬──────────────────────────────────────┘
                           │ Reads
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│  Data Layer (data_parquet/)                                     │
│  Columnar Parquet files                                         │
│  • time.parquet: [step, time]                                  │
│  • scenarios.parquet: [scenario_name, param1..paramN]          │
│  • {variable}.parquet: [scenario_name, step, value, variable]  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Data Structure

### Input (Raw CSV)

Located in `data/`:
- `TIME.csv`: 4725 scenarios × 1905 timesteps (years)
- `scenario_combinations3.xlsx`: Parameter combinations → 4725 scenario rows
- 12 variable CSVs (e.g., `Total population.csv`, `YRB available surface water.csv`): each 4725×1905

### Preprocessed (Parquet)

Generated by `scripts/preprocess_to_parquet.py` → `data_parquet/`:

#### 1. **time.parquet**
```
┌──────┬──────────┐
│ step │ time     │
├──────┼──────────┤
│ 0    │ 1981.0   │
│ 1    │ 1982.0   │
│ ...  │ ...      │
│ 1904 │ 2885.0   │
└──────┴──────────┘
```

#### 2. **scenarios.parquet**
```
┌───────────────┬─────────────────────┬───────────────────┬─────┐
│ scenario_name │ Fertility Variation │ water-saving ... │ ... │
├───────────────┼─────────────────────┼───────────────────┼─────┤
│ sc_0          │ 1.6                 │ 0.8               │ ... │
│ sc_1          │ 1.6                 │ 0.8               │ ... │
│ ...           │ ...                 │ ...               │ ... │
│ sc_4724       │ 1.8                 │ 1.0               │ ... │
└───────────────┴─────────────────────┴───────────────────┴─────┘
```

#### 3. **Variable Parquet** (e.g., `Total population.parquet`)
```
┌───────────────┬──────┬────────────┬──────────────────┐
│ scenario_name │ step │ value      │ variable         │
├───────────────┼──────┼────────────┼──────────────────┤
│ sc_0          │ 0    │ 450000000  │ Total population │
│ sc_0          │ 1    │ 451200000  │ Total population │
│ ...           │ ...  │ ...        │ ...              │
└───────────────┴──────┴────────────┴──────────────────┘
```
Each variable file contains ~9M rows (4725 scenarios × 1905 steps).

---

## API Endpoints

### Base URL
`http://127.0.0.1:8000` (default)

### Endpoints

#### GET `/variables`
Returns list of available variables (excludes TIME).
```json
[
  "GDP per capita",
  "Total population",
  "YRB available surface water",
  ...
]
```

#### GET `/params`
Returns parameter names and their unique values.
```json
{
  "Fertility Variation": [1.6, 1.7, 1.8],
  "water-saving irrigation efficiency ratio": [0.8, 0.9, 1.0],
  ...
}
```

#### POST `/resolve_scenario`
Resolve scenario name from parameter values.
```json
// Request
{
  "values": {
    "Fertility Variation": 1.6,
    "water-saving irrigation efficiency ratio": 0.8,
    ...
  }
}

// Response
{
  "scenario_name": "sc_0"
}
```

#### GET `/time`
Returns time vector.
```json
[
  {"step": 0, "time": 1981.0},
  {"step": 1, "time": 1982.0},
  ...
]
```

#### GET `/series?variable={var}&scenario={sc}&start_step={n}&end_step={m}`
Returns time series for a variable under a scenario.
```json
{
  "variable": "Total population",
  "scenario": "sc_0",
  "series": {
    "time": [1981.0, 1982.0, ...],
    "value": [450000000, 451200000, ...]
  }
}
```

---

## Frontend Structure

```
viz/
├── src/
│   ├── main.tsx                              # Entry point
│   ├── App.tsx                               # Main app with 7-page tabs
│   ├── components/
│   │   ├── charts/
│   │   │   ├── PlotlyChart.tsx              # Reusable Plotly wrapper (with dark mode)
│   │   │   └── BasicChart.tsx               # Fallback chart component
│   │   ├── pages/
│   │   │   ├── EcologicalWaterPageSlider.tsx # ✅ Page 4 (fully integrated)
│   │   │   ├── StudyAreaPage.tsx            # Page 1 (static design)
│   │   │   ├── WaterAvailabilityPage.tsx    # Page 2 (static design)
│   │   │   ├── DemographicsPage.tsx         # Page 3 (static design)
│   │   │   ├── AgriculturePage.tsx          # Page 5 (static design)
│   │   │   ├── WaterStressPage.tsx          # Page 6 (static design)
│   │   │   └── WaterQualityPage.tsx         # Page 7 (static design)
│   │   └── ui/                              # shadcn/Radix UI components
│   ├── services/
│   │   └── api.ts                           # API client functions
│   ├── hooks/
│   │   └── useApiData.ts                    # Data fetching hooks
│   └── styles/
│       └── globals.css                      # Global styles
├── BACKEND_INTEGRATION_GUIDE.md            # 📚 Standard integration guide
├── package.json
├── vite.config.ts
└── index.html
```

### Key Components

#### PlotlyChart
Reusable Plotly component with dark mode support:
```tsx
<PlotlyChart
  id="unique-chart-id"
  title="Chart Title"
  height="400px"
  data={plotlyData}    // Plotly.Data[]
  layout={plotlyLayout}  // Partial<Plotly.Layout> (auto dark mode)
  config={{ responsive: true, displaylogo: false }}
/>
```

#### ✅ Fully Integrated Pages
- **`EcologicalWaterPageSlider.tsx`**: Complete backend integration with slider controls
  - Real-time parameter adjustment (ecological flow: 0.2, 0.25, 0.3)
  - Multi-variable support (surface water, discharge, sediment)
  - Dark mode adaptive charts
  - Statistical analysis panel
  - 2020-2100 time range focus

#### 🎨 Static Design Pages (Ready for Integration)
- `StudyAreaPage.tsx`: Geographic overview with map placeholder
- `WaterAvailabilityPage.tsx`: Climate projections and water availability
- `DemographicsPage.tsx`: Population and demographic trends
- `AgriculturePage.tsx`: Agricultural water use and irrigation
- `WaterStressPage.tsx`: Water stress indicators and vulnerability
- `WaterQualityPage.tsx`: Water quality parameters and pollution

---

## 🎉 Success Story: Ecological Water Integration

### What We Built
A fully functional page demonstrating the complete backend-frontend integration:

- **Real-time Parameter Control**: Slider adjusts ecological flow (0.2, 0.25, 0.3)
- **Multi-Variable Analysis**: Switch between surface water, discharge, and sediment data
- **Dark Mode Support**: Charts automatically adapt to theme changes
- **Statistical Dashboard**: Mean, max, min values with corresponding years
- **2020-2100 Focus**: Optimized for climate projection analysis

### Technical Achievements
- ✅ **API Integration**: Full backend connectivity with error handling
- ✅ **State Management**: Real-time updates with React hooks
- ✅ **Chart Rendering**: Plotly.js with responsive design
- ✅ **Theme Adaptation**: Automatic dark/light mode switching
- ✅ **Performance**: Optimized data loading and caching

### Ready for Scale
This pattern can be applied to all remaining pages using our standardized integration guide.

---

## Quick Start

### 1. Preprocess Data
Convert raw CSVs to Parquet (one-time setup):
```bash
make preprocess
```
This generates `data_parquet/` from `data/` + `scenario_combinations3.xlsx`.

### 2. Start Backend API
```bash
make api
# Runs on http://127.0.0.1:8000
# Visit http://127.0.0.1:8000/docs for interactive API docs
```

### 3. Start Frontend
```bash
cd viz
npm install
npm run dev
# Opens http://localhost:3000 (or 3001/3002 if ports busy)
```

### 4. Explore
- Navigate to **Page 4** (Ecological Water) for full backend integration demo
- Features: Slider controls, variable switching, dark mode, real-time updates
- Check browser Console for API logs and Network tab for `/resolve_scenario` calls

---

## 🪟 Multi-Window Mode

The application supports running each page in a separate browser window with **real-time synchronization** across all windows. When you change a parameter in any window, all other windows update automatically within milliseconds.

### How to Use

1. **Start the backend and frontend** as described above

2. **Open each page in a separate browser window**:
   - Window 1: `http://localhost:5173/page1` (Study Area)
   - Window 2: `http://localhost:5173/page2` (Water Availability)
   - Window 3: `http://localhost:5173/page3` (Demographics)
   - Window 4: `http://localhost:5173/page4` (Ecological Water)
   - Window 5: `http://localhost:5173/page5` (Agriculture)
   - Window 6: `http://localhost:5173/page6` (WSI Focus)
   - Window 7: `http://localhost:5173/page7` (Water Quality)

3. **Arrange windows** across your monitors as needed

4. **Adjust parameters** in any window using the "Parameters" button in the header

5. **Watch synchronization** - all windows update automatically! ⚡

### Technical Details

- **Synchronization**: Uses browser's built-in Broadcast Channel API
- **Latency**: < 10ms between windows
- **Scope**: Works across windows/tabs on the same machine and browser
- **Parameters synced**:
  - Climate Scenario (RCP2.6, RCP4.5, RCP8.5)
  - Fertility Variation (1.6-1.8)
  - Diet Pattern (1-3)
  - Ecological Flow (0.2-0.3)
  - Irrigation Efficiency (0.8-1.0)
  - Fire Generation Share (0.1-0.4)

### Multi-Monitor Setup Example

```
Monitor 1:              Monitor 2:              Monitor 3:
┌────────────────┐      ┌────────────────┐      ┌────────────────┐
│ Page 1         │      │ Page 4         │      │ Page 6         │
│ Study Area     │      │ Ecological     │      │ WSI Focus      │
└────────────────┘      └────────────────┘      └────────────────┘
┌────────────────┐      ┌────────────────┐      ┌────────────────┐
│ Page 2         │      │ Page 5         │      │ Page 7         │
│ Water Avail    │      │ Agriculture    │      │ Water Quality  │
└────────────────┘      └────────────────┘      └────────────────┘
┌────────────────┐
│ Page 3         │
│ Demographics   │
└────────────────┘
```

### Benefits

- ✅ **Simultaneous Viewing**: Compare multiple aspects of water management at once
- ✅ **Instant Updates**: Changes propagate immediately to all windows
- ✅ **Multi-Monitor Support**: Ideal for presentation and analysis workflows
- ✅ **No Backend Changes**: Uses browser-native technology
- ✅ **Maintains All Features**: Dark mode, parameter controls, and visualizations work independently in each window

### Original Single-Window Mode

The original tabbed interface is still available at `http://localhost:5173/` for single-window usage.

---

## Workflow for Design Iteration

### 1. Developer (You)
- Modify backend endpoints in `scripts/api_server.py`
- Update data processing in `scripts/preprocess_to_parquet.py`
- Keep backend running: `make api`

### 2. Designer (Figma Collaboration)
- Works in `viz/src/` (all source code tracked in Git)
- Adjusts layouts, styles, UI components
- Runs `npm run dev` locally to preview changes

### 3. Sync Workflow
```bash
# You commit API + data processing changes
git add scripts/ data_parquet/ pyproject.toml makefile
git commit -m "feat: add new variable endpoint"

# Designer commits frontend changes
cd viz
git add src/
git commit -m "style: update page 3 layout"

# Both push/pull to sync
git push origin master
git pull origin master
```

---

## File Naming Conventions

### Variables
We generate and use "safe variable names" for filenames and APIs while preserving original human-readable names:

- Safe name rules: lowercase; non-alphanumeric → `_`; collapse multiple `_`; trim edges.
- Parquet filenames use safe names, e.g. `data_parquet/yrb_available_surface_water.parquet`.
- Mapping file: `data_parquet/variables_map.json` (original → safe).
- API exposes `GET /variables_map` and accepts either original or safe name in `/series`.

Examples (original → safe):

```
hydrologic station discharge[lijin]           → hydrologic_station_discharge_lijin
YRB available surface water                   → yrb_available_surface_water
sediment load[lijin]                          → sediment_load_lijin
irrigation water demand province sum          → irrigation_water_demand_province_sum
production water demand province sum          → production_water_demand_province_sum
OA water demand province sum                  → oa_water_demand_province_sum
domestic water demand province sum            → domestic_water_demand_province_sum
GDP per capita                                → gdp_per_capita
Total population                              → total_population
YRB WSI                                       → yrb_wsi
water consumption of province in YRB sum      → water_consumption_of_province_in_yrb_sum
```

Frontend/Notebook can display original names while using safe names for stable keys.

### Scenarios
Auto-generated as `sc_0` to `sc_4724` based on parameter combinations.

---

## Dependencies

### Backend (Python)
```toml
# pyproject.toml
python = ">=3.11"
polars = "^1.31.0"
fastapi = "^0.115.0"
uvicorn = {extras = ["standard"], version = "^0.30.6"}
pyarrow = "^21.0.0"
```

Install: `poetry install`

### Frontend (Node.js)
```json
// viz/package.json
"react": "^18.3.1"
"plotly.js-dist-min": "^2.35.2"
"@radix-ui/react-*": "^1.x" (shadcn/ui)
"vite": "6.3.5"
```

Install: `cd viz && npm install`

---

## Troubleshooting

### Frontend doesn't show data
1. Check backend is running: visit `http://127.0.0.1:8000/variables`
2. Check browser Console for API logs and error messages
3. Check Network tab for `/params`, `/resolve_scenario`, `/series` requests
4. Verify parameter names match backend API exactly (case-sensitive)
5. Hard refresh: `Cmd+Shift+R` (macOS) or `Ctrl+Shift+R` (Windows/Linux)

### Dark mode issues
- Charts automatically adapt to theme changes
- If charts don't update: check `isDarkMode()` function and theme listeners

### Port conflicts
- Backend: Change port in `makefile` or run `poetry run uvicorn scripts.api_server:app --port 8001`
- Frontend: Vite auto-increments (3000→3001→3002...), or set in `vite.config.ts`

### CORS errors
Backend already allows all origins (`allow_origins=["*"]`). If still blocked, check browser console for exact error.

---

## Analysis Workflow (Python/Jupyter)

### ScenarioQuery API

Use `scripts/query_scenarios.py` to filter and extract data for analysis:

```python
from scripts.query_scenarios import ScenarioQuery, quick_query, compare_params

# Initialize query engine
query = ScenarioQuery("data_parquet")

# List available variables and parameters
query.list_variables()
query.param_cols

# Filter scenarios by parameter constraints
filtered = query.filter_scenarios({
    "Fertility Variation": 1.6,
    "Climate change scenario switch for water yield": 1
})
print(f"Matching scenarios: {filtered.height}")

# Get time series for variable(s) under constraints
data = query.get_series(
    variables=["Total population", "YRB WSI"],
    filters={"Fertility Variation": 1.6},
    time_range=(2020, 2050)
)

# Compare parameter impact (wide format for plotting)
comparison = compare_params(
    variable="YRB WSI",
    fixed_params={"Fertility Variation": 1.6, "Diet change scenario switch": 1},
    vary_param="water-saving irrigation efficiency ratio",
    time_range=(2020, 2100)
)
# Result: rows=time, columns=parameter values (0.8, 0.9, 1.0)
```

See `docs/example_usage.ipynb` for complete examples.

### Key Methods

| Method | Purpose | Returns |
|--------|---------|---------|
| `filter_scenarios(filters)` | Get scenarios matching parameter constraints | DataFrame of scenarios |
| `get_series(variables, filters, time_range)` | Get time series in long format | DataFrame [scenario, variable, step, time, value, params...] |
| `get_series_wide(variable, filters, columns_col)` | Get time series pivoted for comparison | DataFrame [time, param_val_1, param_val_2, ...] |
| `list_variables()` | List all available variables | List of strings |
| `get_param_summary(filters)` | Summarize parameter distributions | DataFrame of parameter stats |

---

## Next Steps

### 🎯 Immediate Priority
1. **Apply Integration Pattern**: Use `viz/BACKEND_INTEGRATION_GUIDE.md` to integrate remaining 5 pages
2. **Standard Template**: Copy `EcologicalWaterPageSlider.tsx` as starting point for each page
3. **Parameter Mapping**: Each page focuses on different parameter combinations

### For Backend
- Add batch endpoints: `GET /series/batch` for multiple variables/scenarios
- Implement downsampling (LTTB algorithm) for large time series
- Add statistical bands (p10/p90) for scenario ensembles

### For Frontend
- ✅ **Completed**: Ecological Water page with full backend integration
- **Next**: Apply integration pattern to remaining 5 pages using `BACKEND_INTEGRATION_GUIDE.md`
- **Standard Process**: Copy `EcologicalWaterPageSlider.tsx` → modify parameters → update variables
- Add multi-variable comparison (overlay multiple series)
- Implement export (PNG/CSV download)

---

## License

MIT

---

## Contact

Maintained by SongshGeo <songshgeo@gmail.com>

Project Repository: https://github.com/SongshGeoLab/YR-WatM-DT

For issues or questions, please visit the repository or open an issue.
